<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Signup - Workout Tracker</title>
  <link rel="stylesheet" href="/style.css?v=9999">
</head>
<body>
  <h1>Sign Up</h1>
  <form id="signup-form" autocomplete="off">
    <input type="text" id="username" placeholder="Username" required />
    <input type="password" id="password" placeholder="Password" required />
    <button type="submit">Sign Up</button>
  </form>

  <p>Already have an account? <a href="login.html">Login here</a></p>

  <div id="msg" role="status" aria-live="polite" style="color: red; margin-top:10px;"></div>

  <script>
    const API_BASE = ''; // keep empty for same origin, or set to 'https://workouttracker-d5wa.onrender.com'
    const SIGNUP_API = API_BASE + '/api/auth/signup';
    const LOGIN_API  = API_BASE + '/api/auth/login';

    const form = document.getElementById('signup-form');
    const msg = document.getElementById('msg');

    function showMsg(text, color='red') {
      msg.style.color = color;
      msg.textContent = text;
    }

    async function attemptLoginAfterSignup(username, password) {
      // Call login to try and get id/structured response if signup returns only text
      try {
        const res = await fetch(LOGIN_API, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username, password })
        });

        const contentType = res.headers.get('Content-Type') || '';
        let body = null;
        if (contentType.includes('application/json')) {
          body = await res.json();
        } else {
          body = await res.text();
        }

        if (!res.ok) {
          // login failed for some reason after signup — show message
          showMsg(typeof body === 'string' ? body : (body?.error || 'Login failed after signup'));
          return false;
        }

        // store known info
        if (body && typeof body === 'object') {
          if (body.id) localStorage.setItem('user_id', String(body.id));
          if (body.username) localStorage.setItem('username', body.username);
        } else {
          // backend returned a simple "ok" string or similar — we at least store username locally
          localStorage.setItem('username', username);
        }

        return true;
      } catch (err) {
        console.warn('Auto-login failed:', err);
        // still store username locally so tracker can work in local-mode
        localStorage.setItem('username', username);
        return true;
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      if (!username || !password) {
        showMsg('Username and password required.');
        return;
      }

      try {
        const res = await fetch(SIGNUP_API, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username, password })
        });

        const ct = res.headers.get('Content-Type') || '';
        let body;
        if (ct.includes('application/json')) {
          body = await res.json();
        } else {
          body = await res.text();
        }

        // handle duplicate username cases gracefully:
        if (res.status === 409) {
          showMsg('Username already in use.');
          return;
        }

        // Many backends may throw 500 when duplicate; map that to a helpful message
        if (res.status === 500) {
          // If response contains a helpful message, show it; otherwise show generic duplicate message
          const serverMsg = typeof body === 'string' ? body : (body?.error || body?.message);
          if (serverMsg && /user|username|duplicate|already/i.test(String(serverMsg))) {
            showMsg('Username already in use.');
          } else {
            showMsg(serverMsg || 'Server error during signup. Try again.');
          }
          return;
        }

        if (!res.ok) {
          // other client/server errors
          showMsg(typeof body === 'string' ? body : (body?.error || 'Signup failed'));
          return;
        }

        // success path
        if (body && typeof body === 'object' && body.id) {
          // server returned JSON with id/username — store and redirect
          localStorage.setItem('user_id', String(body.id));
          localStorage.setItem('username', body.username || username);
          window.location.href = 'tracker.html';
          return;
        }

        // if server returned a success text (e.g. "registered" or "ok") but no id,
        // attempt to login automatically to fetch a user id or at least ensure credentials work.
        const autoLoginOk = await attemptLoginAfterSignup(username, password);
        if (autoLoginOk) {
          window.location.href = 'tracker.html';
        } else {
          showMsg('Signup succeeded but auto-login failed — please login manually.');
        }

      } catch (err) {
        console.error(err);
        showMsg('Network error while signing up.');
      }
    });
  </script>
</body>
</html>
