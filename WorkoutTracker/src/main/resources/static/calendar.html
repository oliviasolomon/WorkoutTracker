<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Workout Calendar</title>
  <link rel="stylesheet" href="/style.css?v=abc123">
</head>
<body>
  <nav class="top-nav container" role="navigation" aria-label="Main Navigation">
    <div class="brand">Workout Tracker</div>
    <div class="nav-links">
      <a href="home.html">Home</a>
      <a href="metrics.html">Metrics</a>
      <a href="calendar.html" class="active">Calendar</a>
      <button id="logoutBtn" class="logout-btn">Sign Out</button>
    </div>
  </nav>

  <div class="container calendar-layout">
    <div class="calendar-container">
      <div class="calendar-header">
      <h2 id="monthYear">November 2025</h2>
      <div class="calendar-nav">
        <button id="prevMonth">← Previous</button>
        <button id="today">Today</button>
        <button id="nextMonth">Next →</button>
      </div>
    </div>

    <div class="weekdays">
      <div class="weekday">Sunday</div>
      <div class="weekday">Monday</div>
      <div class="weekday">Tuesday</div>
      <div class="weekday">Wednesday</div>
      <div class="weekday">Thursday</div>
      <div class="weekday">Friday</div>
      <div class="weekday">Saturday</div>
    </div>

      <div class="calendar-days" id="calendarDays"></div>
      </div>
    </div>

  <!-- Workout Modal -->
  <div class="modal" id="workoutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalDate">Add Workout</h3>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>

      <form id="workoutForm">
        <div class="form-group">
          <label for="exercise">Exercise</label>
          <select id="exercise" required>
            <option value="">Select Exercise</option>
          </select>
        </div>

        <div class="form-group">
          <label for="sets">Sets</label>
          <input type="number" id="sets" placeholder="e.g., 3" required min="1" />
        </div>

        <div class="form-group">
          <label for="reps">Reps</label>
          <input type="number" id="reps" placeholder="e.g., 10" required min="1" />
        </div>

        <div class="form-group">
          <label for="weight">Weight (lbs)</label>
          <input type="number" id="weight" placeholder="Optional" step="0.5" />
        </div>

        <div class="form-group">
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Add any notes about this workout..."></textarea>
        </div>

        <div class="modal-actions">
          <button type="submit" class="btn-save">Add Workout</button>
          <button type="button" class="btn-cancel" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const userIdRaw = localStorage.getItem('user_id');
    const userId = userIdRaw ? parseInt(userIdRaw, 10) : null;
    const username = localStorage.getItem('username') || null;

    if (!userId && !username) {
      alert('Please sign up or log in first.');
      window.location.href = 'signup.html';
    }

    const API_BASE = '';
    const EXERCISES_API = API_BASE + '/api/exercises';
    const WORKOUTS_API = API_BASE + '/api/logs';
    const DEFAULT_EXERCISES = [
      'Bench Press', 'Squat', 'Deadlift', 'Overhead Press', 'Pull Ups', 'Barbell Row', 'Leg Press'
    ];

    let currentDate = new Date();
    let selectedDate = null;
    let allWorkouts = [];

    // DOM Elements
    const monthYearEl = document.getElementById('monthYear');
    const calendarDaysEl = document.getElementById('calendarDays');
    const workoutModal = document.getElementById('workoutModal');
    const modalDateEl = document.getElementById('modalDate');
    const workoutForm = document.getElementById('workoutForm');
    const exerciseSelect = document.getElementById('exercise');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');

    // Navigation buttons
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    });

    document.getElementById('today').addEventListener('click', () => {
      currentDate = new Date();
      renderCalendar();
    });

    // Modal controls
    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    workoutModal.addEventListener('click', (e) => {
      if (e.target === workoutModal) {
        closeModal();
      }
    });

    // Load exercises on page load
    async function loadExercises() {
      try {
        const res = await fetch(EXERCISES_API);
        if (!res.ok) throw new Error('no exercises endpoint');
        const exercises = await res.json();
        populateExercises(Array.isArray(exercises) && exercises.length ? exercises : DEFAULT_EXERCISES);
      } catch (err) {
        console.warn('loadExercises failed, using defaults:', err);
        populateExercises(DEFAULT_EXERCISES);
      }
    }

    function populateExercises(exList) {
      exerciseSelect.innerHTML = '<option value="">Select Exercise</option>';
      exList.forEach(ex => {
        const opt = document.createElement('option');
        opt.value = ex;
        opt.textContent = ex;
        exerciseSelect.appendChild(opt);
      });
    }

    // Fetch all logs
    async function fetchWorkouts() {
      let workouts = [];
      if (userId) {
        try {
          const res = await fetch(`${WORKOUTS_API}?user_id=${encodeURIComponent(userId)}`);
          if (!res.ok) throw new Error('backend fetch failed');
          workouts = await res.json();
          allWorkouts = workouts;
          renderCalendar();
          return;
        } catch (err) {
          console.warn('Fetching workouts from backend failed, falling back to localStorage:', err);
        }
      }

      const localKey = `wt_${username}`;
      const stored = localStorage.getItem(localKey);
      workouts = stored ? JSON.parse(stored) : [];
      allWorkouts = workouts;
      renderCalendar();
    }

    function getWorkoutsForDate(date) {
      const dateStr = date.toISOString().split('T')[0]; // YYYY-MM-DD
      return allWorkouts.filter(w => {
        const workoutDate = new Date(w.createdAt || w.date || 0).toISOString().split('T')[0];
        return workoutDate === dateStr;
      });
    }

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
// Update header
      const monthName = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
      monthYearEl.textContent = monthName;
// Get first day of month and number of days
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const daysInPrevMonth = new Date(year, month, 0).getDate();
// Clear calendar
      calendarDaysEl.innerHTML = '';
      // Previous month's days
      for (let i = firstDay - 1; i >= 0; i--) {
        const day = daysInPrevMonth - i;
        const dayEl = createDayElement(day, true);
        calendarDaysEl.appendChild(dayEl);
      }
// Current month's days
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        const dayEl = createDayElement(day, false, date);
        calendarDaysEl.appendChild(dayEl);
      }
// Next month's days
      const totalCells = calendarDaysEl.children.length;
      const remainingCells = 42 - totalCells;
      for (let day = 1; day <= remainingCells; day++) {
        const dayEl = createDayElement(day, true);
        calendarDaysEl.appendChild(dayEl);
      }
    }

    function createDayElement(day, isOtherMonth, date = null) {
      const dayEl = document.createElement('div');
      dayEl.className = 'day' + (isOtherMonth ? ' other-month' : '');

      const dayNumberEl = document.createElement('div');
      dayNumberEl.className = 'day-number';
      dayNumberEl.textContent = day;
      dayEl.appendChild(dayNumberEl);

      if (!isOtherMonth && date) {
        const workoutsEl = document.createElement('div');
        workoutsEl.className = 'day-workouts';

        const workouts = getWorkoutsForDate(date);
        workouts.slice(0, 2).forEach(w => {
          const itemEl = document.createElement('div');
          itemEl.className = 'workout-item';
          itemEl.title = `${w.exercise || w.exerciseName} - ${w.sets}x${w.reps}`;
          itemEl.textContent = `${w.exercise || w.exerciseName}`;
          workoutsEl.appendChild(itemEl);
        });

        if (workouts.length > 2) {
          const moreEl = document.createElement('div');
          moreEl.className = 'workout-item';
          moreEl.textContent = `+${workouts.length - 2} more`;
          workoutsEl.appendChild(moreEl);
        }

        dayEl.appendChild(workoutsEl);

        dayEl.addEventListener('click', () => openModal(date));
      }

      return dayEl;
    }

    function openModal(date) {
      selectedDate = date;
      const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
      modalDateEl.textContent = `Add Workout - ${dateStr}`;
      workoutForm.reset();
      workoutModal.classList.add('active');
    }

    function closeModal() {
      workoutModal.classList.remove('active');
      selectedDate = null;
    }
// If a ?focus=<ISO date> query param exists, navigate to that date and open modal
    function processFocusFromQuery() {
      try {
        const params = new URLSearchParams(window.location.search);
        const focus = params.get('focus');
        if (!focus) return;
        const d = new Date(focus);
        if (isNaN(d.getTime())) return;
        currentDate = new Date(d.getFullYear(), d.getMonth(), 1);
        renderCalendar();
              // open modal for that day after render
        setTimeout(() => openModal(new Date(d.getFullYear(), d.getMonth(), d.getDate())), 80);
      } catch (err) {
        console.warn('processFocusFromQuery error', err);
      }
    }

    // Handle form submission
    workoutForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const exercise = exerciseSelect.value;
      const sets = parseInt(document.getElementById('sets').value, 10);
      const reps = parseInt(document.getElementById('reps').value, 10);
      const weightRaw = document.getElementById('weight').value;
      const weight = weightRaw ? parseFloat(weightRaw) : null;
      const notes = document.getElementById('notes').value;

      if (!exercise || !selectedDate) {
        alert('Please select an exercise.');
        return;
      }

      const payload = {
        user_id: userId,
        username: username,
        exercise: exercise,
        sets: sets,
        reps: reps,
        weight: weight,
        units: 'lbs',
        muscle_group: null,
        notes: notes,
        date: selectedDate.toISOString()
      };

      if (userId) {
        try {
          const res = await fetch(WORKOUTS_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const error = await (res.headers.get('Content-Type')?.includes('application/json') ? res.json() : res.text());
            alert(error?.error || error || 'Failed to save workout');
            return;
          }

          const saved = await (res.headers.get('Content-Type')?.includes('application/json') ? res.json() : res.text());
          allWorkouts.push(saved || payload);
        } catch (err) {
          console.warn('POST to backend failed, falling back to localStorage:', err);
          allWorkouts.push(payload);
        }
      } else {
        const localKey = `wt_${username}`;
        const stored = localStorage.getItem(localKey);
        const arr = stored ? JSON.parse(stored) : [];
        arr.push(payload);
        localStorage.setItem(localKey, JSON.stringify(arr));
        allWorkouts.push(payload);
      }

      renderCalendar();
      closeModal();
      alert('Workout added successfully!');
    });

    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('user_id');
      localStorage.removeItem('username');
      sessionStorage.clear();
      window.location.href = 'login.html';
    });

    // Initialize
    loadExercises();
    fetchWorkouts().then(() => processFocusFromQuery());
  </script>
</body>
</html>
